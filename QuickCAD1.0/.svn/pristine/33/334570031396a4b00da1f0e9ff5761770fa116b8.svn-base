<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>子任务Deail</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/lib/layui-v2.9.2/css/layui.css" media="all">
    <link rel="stylesheet" href="/css/public.css" media="all">
    <style>
        body {
            background-color: #ffffff;
        }
        .inline-div {
            display: inline-block;
            margin-right: 10px; /* 可根据需要调整间距 */
        }
    </style>
</head>
<body>
    <div class="layui-form layuimini-form">
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label  required">命令码</label>
            <div class="layui-input-block">
                <input id="cmd" name="cmd" type="text" placeholder="请输入命令码" value="" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label  required">任务名称</label>
            <div class="layui-input-block">
                <input id="taskName" name="taskName" type="text" placeholder="任务名称" value="" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label  required">任务描述</label>
            <div class="layui-input-block">
                <input id="taskDes" name="taskDes" type="text" placeholder="任务描述" value="" class="layui-input" lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">业务类型</label>
            <div class="layui-input-block">
                <select id="bizType" name="bizType" lay-search="" lay-verify="required">
                    <option value="0" selected>数据同步</option>
                    <option value="1">日志同步</option>
                    <option value="2">时间同步</option>
                    <option value="3">字符叠加</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">任务类型</label>
            <div class="layui-input-block">
                <select id="taskType" name="taskType" lay-search="">
                    <option value="">直接选择或搜索选择</option>
                    <option value="ACG">全表类常规任务</option>
                    <option value="ADK">全表类大库任务</option>
                    <option value="CCG">区间类常规任务</option>
                    <option value="CDK">区间类大库任务</option>
                    <option value="TCG">统计类常规任务</option>
                    <option value="TDK">统计类大库任务</option>
                    <option value="LIS">历史变更类任务</option>
                </select>
                <div class="layui-form-select">
                    <div class="layui-select-title">
                        <input id="dbType1" type="text" placeholder="直接选择或搜索选择" value="" class="layui-input"><i class="layui-edge"></i>
                    </div>
                    <dl id="dbType2" class="layui-anim layui-anim-upbit" style="">
                        <dd lay-value="" class="layui-select-tips layui-this">直接选择或搜索选择</dd>
                        <dd lay-value="ACG" class="">全表类基础任务</dd>
                        <dd lay-value="ADK" class="">全表类大库任务</dd>
                        <dd lay-value="CCG" class="">区间类常规任务</dd>
                        <dd lay-value="CDK" class="">区间类大库任务</dd>
                        <dd lay-value="TCG" class="">统计类常规任务</dd>
                        <dd lay-value="TDK" class="">统计类大库任务</dd>
                        <dd lay-value="LIS" class="">历史变更类任务</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label required">任务优先级</label>
            <div class="layui-input-block">
                <input id="priorityLevel" name="priorityLevel" type="number" autocomplete="off" class="layui-input" min="1" step="1" lay-affix="number"  lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">切片类型</label>
            <div class="layui-input-block">
                <input type="checkbox" name="cutType" value="Y" lay-skin="tag" title="按年拆分">
                <input type="checkbox" name="cutType" value="M" lay-skin="tag" title="按月拆分">
                <input type="checkbox" name="cutType" value="D" lay-skin="tag" title="按日拆分" checked>
                <input type="checkbox" name="cutType" value="H" lay-skin="tag" title="按小时拆分">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">操作类型</label>
            <div class="layui-input-block">
                <input type="radio" name="czType" value="R" title="更新" checked>
                <input type="radio" name="czType" value="D" title="删除" disabled>
                <input type="radio" name="czType" value="DR" title="先删除再更新">
                <input type="radio" name="czType" value="CR" title="先清空再更新">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label  required">启用状态</label>
            <div class="layui-input-block">
                <input type="checkbox" name="taskState" lay-skin="switch" lay-filter="switchTest" title="true|false"  lay-verify="required">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">延迟时长</label>
            <div class="layui-input-block">
                <input id="delayTime" name="delayTime" type="number" autocomplete="off" class="layui-input" min="0" step="1" lay-affix="number">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">隔离器标识集</label>
            <div class="layui-input-block">
                <div class="inline-div">
                    <div id="wz_transfer" name="wz_transfer" class="layui-transfer"></div>
                </div>
                <div class="inline-div">
                    <div id="ck_transfer" name="ck_transfer" class="layui-transfer"></div>
                </div>
                <div class="inline-div">
                    <div id="ckfwq_transfer" name="ckfwq_transfer" class="layui-transfer"></div>
                </div>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">关联数据库</label>
            <div class="layui-input-block">
                <div id="db_transfer" name="relatedTasks" class="layui-transfer"></div>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">关联任务</label>
            <div class="layui-input-block">
                <div id="sub_transfer" name="relatedTasks" class="layui-transfer"></div>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">SQL语句</label>
            <div class="layui-input-block">
                <textarea id="sqlStr" name="sqlStr" class="layui-textarea" placeholder="请输入SQL语句"></textarea>
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">变更依据字段</label>
            <div class="layui-input-block">
                <input id="bgYjFiled" name="bgYjFiled" type="text" placeholder="变更依据字段" value="" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">变更SQL语句</label>
            <div class="layui-input-block">
                <textarea id="bgSqlStr" name="bgSqlStr" class="layui-textarea" placeholder="请输入变更SQL语句"></textarea>
            </div>
        </div>
        <div class="layui-form-item" id="saveBtn">
            <div class="layui-input-block">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn" id="saveBtn1">确认保存</button>
            </div>
        </div>

        <hr>
        <div style="color: #666;margin-top: 30px;margin-bottom: 40px;padding-left: 30px;">
            <h3>说明1</h3><br>
            <h4>说明2</h4>
            <p>如果需要，这里可以放一些说明。</p><br>
            <h4>说明3</h4>
            <p>如果需要，这里可以放一些说明。</p>
        </div>
    </div>
    </div>
    <script src="/lib/jquery-3.4.1/jquery.js" charset="utf-8"></script>
    <script src="/lib/layui-v2.9.2/layui.js" charset="utf-8"></script>
    <script>
        var parentMod = parent.parentMod;//全局变量，子页面获取父页面传来的参数。
        var subPageState = parent.subPageState;//全局变量，子页面状态('copy','look','add','edit')
        layui.use(['form', 'transfer'], function () {
            var $ = layui.$;
            var form = layui.form;
            var transfer = layui.transfer;
            var layer = layui.layer;
            var apiUrl; //接口地址

            Init();//页面初始化

            var sub_transfer_data = []; //transfer数据
            $.ajax({
                type: 'GET',
                url: '/ProduceTask/SearchAll', //接口地址
                cache: false, //是否使用缓存
                dataType: "json",//数据类型
                success: function (res) {
                    if (res.code == 0) {
                        if (res.data.length > 0) {
                            res.data.forEach(function (item) {
                                sub_transfer_data.push({ "value": item.cmd, "title": item.taskName });
                            });
                        }
                    }

                    var transfer_check_data = []; //transfer选中的数据
                    if (subPageState == 'look' || subPageState == 'edit') {
                        transfer_check_data = parentMod.relatedTasks?.split(",");
                    }

                    // 初始化Transfer组件
                    transfer.render({
                        elem: '#sub_transfer',
                        title: ['待选数据', '已选数据'],
                        data: sub_transfer_data,
                        id: 'sub_transfer',
                        value: transfer_check_data // 设置默认选中的数据，根据实际需求进行设置
                    });
                },
                error: function () {
                    layer.msg('请求接口失败');
                }
            });

            //页面初始化
            function Init() {
                RenderDbTransfer();
                RenderWzTransfer();
                RenderCkTransfer();
                RenderCkfwqTransfer();
                switch (subPageState) {
                    case 'look': { //查看
                        $('#saveBtn').hide();//隐藏，不占位
                        $("#cmd").val(parentMod.cmd);
                        $('#cmd').attr("disabled", true);
                        $("#taskName").val(parentMod.taskName);
                        $('#taskName').attr("disabled", true);
                        $("#taskDes").val(parentMod.taskDes);
                        $('#taskDes').attr("disabled", true);
                        $("#taskType").val(parentMod.taskType);
                        $('#taskType').attr("disabled", true);
                        $("#priorityLevel").val(parentMod.priorityLevel);
                        $('#priorityLevel').attr("disabled", true);
                        $('input[type=checkbox][name="cutType"]').each(function () {
                            var value = $(this).val();
                            var cutTypes = parentMod.cutType.split(",");
                            if (cutTypes.includes(value)) { //判断是否包含
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('#cutType').attr("disabled", true);
                        $('input[type=radio][name="czType"]').each(function () {
                            var value = $(this).val();
                            if (parentMod.czType == value) {
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('#czType').attr("disabled", true);
                        $('input[type=checkbox][name="taskState"]').prop('checked', parentMod.taskState);
                        $('#taskState').attr("disabled", true);
                        $("#delayTime").val(parentMod.delayTime);
                        $('#delayTime').attr("disabled", true);
                        $("#dbs_transfer").val(parentMod.dbs);
                        $('#dbs_transfer').attr("disabled", true);
                        $("#sqlStr").val(parentMod.sqlStr);
                        $('#sqlStr').attr("disabled", true);
                        $("#bgYjFiled").val(parentMod.bgYjFiled);
                        $('#bgYjFiled').attr("disabled", true);
                        $("#bgSqlStr").val(parentMod.bgSqlStr);
                        $('#bgSqlStr').attr("disabled", true);
                        form.render("select");
                        form.render('checkbox');
                    } break;
                    case 'add': { //新增
                        apiUrl = '/ProduceTask/Add';
                    } break;
                    case 'edit': { //编辑
                        apiUrl = '/ProduceTask/Update';
                        $("#cmd").val(parentMod.cmd);
                        $('#cmd').attr("disabled", true);
                        $("#taskName").val(parentMod.taskName);
                        $("#taskDes").val(parentMod.taskDes);
                        $("#taskType").val(parentMod.taskType);
                        $("#priorityLevel").val(parentMod.priorityLevel);
                        $('input[type=checkbox][name="cutType"]').each(function () {
                            var value = $(this).val();
                            var cutTypes = parentMod.cutType.split(",");
                            if (cutTypes.includes(value)) { //判断是否包含
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('input[type=radio][name="czType"]').each(function () {
                            var value = $(this).val();
                            if (parentMod.czType == value) {
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('input[type=checkbox][name="taskState"]').prop('checked', parentMod.taskState);
                        $("#delayTime").val(parentMod.delayTime);
                        $("#dbs_transfer").val(parentMod.dbs);
                        $("#sqlStr").val(parentMod.sqlStr);
                        $("#bgYjFiled").val(parentMod.bgYjFiled);
                        $("#bgSqlStr").val(parentMod.bgSqlStr);
                        form.render("select");
                        form.render('checkbox');
                    } break;
                    case 'copy': { //拷贝
                        apiUrl = '/ProduceTask/Add';
                        $("#cmd").val(parentMod.cmd);
                        $("#taskName").val(parentMod.taskName);
                        $("#taskDes").val(parentMod.taskDes);
                        $("#taskType").val(parentMod.taskType);
                        $("#priorityLevel").val(parentMod.priorityLevel);
                        $('input[type=checkbox][name="cutType"]').each(function () {
                            var value = $(this).val();
                            var cutTypes = parentMod.cutType.split(",");
                            if (cutTypes.includes(value)) { //判断是否包含
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('input[type=radio][name="czType"]').each(function () {
                            var value = $(this).val();
                            if (parentMod.czType == value) {
                                $(this).prop('checked', true);
                            } else {
                                $(this).prop('checked', false);
                            }
                        });
                        $('input[type=checkbox][name="taskState"]').prop('checked', parentMod.taskState);
                        $("#delayTime").val(parentMod.delayTime);
                        $("#dbs_transfer").val(parentMod.dbs);
                        $("#sqlStr").val(parentMod.sqlStr);
                        $("#bgYjFiled").val(parentMod.bgYjFiled);
                        $("#bgSqlStr").val(parentMod.bgSqlStr);
                        form.render("select");
                        form.render('checkbox');
                    } break;
                    default: break;
                }
            }

            //渲染数据库穿梭框
            function RenderDbTransfer() {
                var db_transfer_data = []; //数据库transfer数据
                $.ajax({
                    type: 'GET',
                    url: '/UseDb/SearchAll', //接口地址
                    cache: false, //是否使用缓存
                    dataType: "json",//数据类型
                    success: function (res) {
                        if (res.code == 0) {
                            if (res.data.length > 0) {
                                res.data.forEach(function (item) {
                                    db_transfer_data.push({ "value": item.id, "title": item.dbDescribe });
                                });
                            }
                        }

                        var transfer_check_data = []; //transfer选中的数据
                        if (subPageState == 'look' || subPageState == 'edit') {
                            transfer_check_data = parentMod.dbs.split(",");
                        }

                        // 初始化Transfer组件
                        transfer.render({
                            elem: '#db_transfer',
                            title: ['待选数据库', '已选数据库'],
                            data: db_transfer_data,
                            id: 'db_transfer',
                            value: transfer_check_data // 设置默认选中的数据，根据实际需求进行设置
                        });
                    },
                    error: function () {
                        layer.msg('请求接口失败');
                        if (err.status == 401) {
                            parent.location.href = "/Home/Login";
                        }
                    }
                });
            }

            //渲染网闸穿梭框
            function RenderWzTransfer() {
                var wz_transfer_data = []; //网闸transfer数据
                $.ajax({
                    type: 'GET',
                    url: '/Gatekeeper/SearchAll', //接口地址
                    cache: false, //是否使用缓存
                    dataType: "json",//数据类型
                    success: function (res) {
                        if (res.code == 0) {
                            if (res.data.length > 0) {
                                res.data.forEach(function (item) {
                                    wz_transfer_data.push({ "value": item.id, "title": item.id });
                                });
                            }
                        }

                        var transfer_check_data = []; //transfer选中的数据
                        if (subPageState == 'look' || subPageState == 'edit') {
                            transfer_check_data = parentMod.isolators.split(",");
                        }

                        // 初始化Transfer组件
                        transfer.render({
                            elem: '#wz_transfer',
                            title: ['待选网闸', '已选网闸'],
                            data: wz_transfer_data,
                            id: 'wz_transfer',
                            value: transfer_check_data // 设置默认选中的数据，根据实际需求进行设置
                        });
                    },
                    error: function () {
                        layer.msg('请求接口失败');
                        if (err.status == 401) {
                            parent.location.href = "Home/Login";
                        }
                    }
                });
            }

            //渲染串口穿梭框
            function RenderCkTransfer() {
                var ck_transfer_data = []; //串口transfer数据
                $.ajax({
                    type: 'GET',
                    url: '/SerialPort/SearchAll', //接口地址
                    cache: false, //是否使用缓存
                    dataType: "json",//数据类型
                    success: function (res) {
                        if (res.code == 0) {
                            if (res.data.length > 0) {
                                res.data.forEach(function (item) {
                                    ck_transfer_data.push({ "value": item.id, "title": item.id });
                                });
                            }
                        }

                        var transfer_check_data = []; //transfer选中的数据
                        if (subPageState == 'look' || subPageState == 'edit') {
                            transfer_check_data = parentMod.isolators.split(",");
                        }

                        // 初始化Transfer组件
                        transfer.render({
                            elem: '#ck_transfer',
                            title: ['待选串口', '已选串口'],
                            data: ck_transfer_data,
                            id: 'ck_transfer',
                            value: transfer_check_data // 设置默认选中的数据，根据实际需求进行设置
                        });
                    },
                    error: function () {
                        layer.msg('请求接口失败');
                        if (err.status == 401) {
                            parent.location.href = "Home/Login";
                        }
                    }
                });
            }

            //渲染串口服务器穿梭框
            function RenderCkfwqTransfer() {
                var ckfwq_transfer_data = []; //串口服务器transfer数据
                $.ajax({
                    type: 'GET',
                    url: '/SerialServer/SearchAll', //接口地址
                    cache: false, //是否使用缓存
                    dataType: "json",//数据类型
                    success: function (res) {
                        if (res.code == 0) {
                            if (res.data.length > 0) {
                                res.data.forEach(function (item) {
                                    ckfwq_transfer_data.push({ "value": item.id, "title": item.id });
                                });
                            }
                        }

                        var transfer_check_data = []; //transfer选中的数据
                        if (subPageState == 'look' || subPageState == 'edit') {
                            transfer_check_data = parentMod.isolators.split(",");
                        }

                        // 初始化Transfer组件
                        transfer.render({
                            elem: '#ckfwq_transfer',
                            title: ['待选串口服务器', '已选串口服务器'],
                            data: ckfwq_transfer_data,
                            id: 'ckfwq_transfer',
                            value: transfer_check_data // 设置默认选中的数据，根据实际需求进行设置
                        });
                    },
                    error: function () {
                        layer.msg('请求接口失败');
                        if (err.status == 401) {
                            parent.location.href = "Home/Login";
                        }
                    }
                });
            }

            //监听提交
            form.on('submit(saveBtn)', function (data) {
                var cutTypes = ""; //存储选中的复选框值
                $('input[type=checkbox][name="cutType"]:checked').each(function () {
                    cutTypes += $(this).val() + ",";
                });
                data.field.cutType = cutTypes.substring(0, cutTypes.lastIndexOf(','));

                var isolators = ""; //存储选中的transfer
                var wz_transfer_check_data = transfer.getData('wz_transfer');
                wz_transfer_check_data.forEach(function (item) {
                    isolators += item.value + ",";
                });
                var ck_transfer_check_data = transfer.getData('ck_transfer');
                ck_transfer_check_data.forEach(function (item) {
                    isolators += item.value + ",";
                });
                var ckfwq_transfer_check_data = transfer.getData('ckfwq_transfer');
                ckfwq_transfer_check_data.forEach(function (item) {
                    isolators += item.value + ",";
                });
                data.field.isolators = isolators.substring(0, isolators.lastIndexOf(','));

                var dbs = ""; //存储选中的transfer
                var db_transfer_check_data = transfer.getData('db_transfer');
                db_transfer_check_data.forEach(function (item) {
                    dbs += item.value + ",";
                });
                data.field.dbs = dbs.substring(0, dbs.lastIndexOf(','));

                var relatedTasks = ""; //存储选中的transfer
                var sub_transfer_check_data = transfer.getData('sub_transfer');
                sub_transfer_check_data.forEach(function (item) {
                    relatedTasks += item.value + ",";
                });
                data.field.relatedTasks = relatedTasks.substring(0, dbs.lastIndexOf(','));

                $.ajax({
                    type: 'POST',
                    url: apiUrl, //接口地址
                    cache: false, //是否使用缓存
                    dataType: "json",//数据类型
                    data: data.field,//form数据
                    success: function (res) {//函数参数 "data" 为请求成功服务端返回的数据
                        layer.msg(res.msg);
                        if (res.code == 0) {
                            window.parent.location.reload();
                            var iframeIndex = parent.layer.getFrameIndex(window.name);
                            parent.layer.close(iframeIndex);//关闭iframe
                        }
                    },
                    error: function (err) {
                        layer.msg("接口【" + apiUrl + "】请求错误，状态码：" + err.status);
                        if (err.status == 401) {
                            parent.location.href = "/Hmoe/Login";
                        }
                    }
                });

                return false;
            });
        });
    </script>
</body>
</html>