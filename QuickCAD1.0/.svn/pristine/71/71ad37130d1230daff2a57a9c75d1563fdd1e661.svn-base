using System;
using System.Collections.Concurrent;

namespace Max.ISolator.KafkaKit
{
    public class KafkaManager
    {
        #region 单例
        private static KafkaManager i;
        private readonly static object objLock = new object();
        public static KafkaManager I
        {
            get
            {
                if (i == null)
                {
                    lock (objLock)
                    {
                        if (i == null)
                        {
                            i = new KafkaManager();
                        }
                    }
                }
                return i;
            }
        }
        #endregion

        /// <summary>
        /// 生产者
        /// </summary>
        private readonly ConcurrentDictionary<KafkaProducerMod, KafkaProducer> _Producers = new ConcurrentDictionary<KafkaProducerMod, KafkaProducer>();
        /// <summary>
        /// 消费者
        /// </summary>
        private readonly ConcurrentDictionary<KafkaConsumerMod, KafkaConsumer> _Consumers = new ConcurrentDictionary<KafkaConsumerMod, KafkaConsumer>();

        /// <summary>
        /// 消费者注册
        /// </summary>
        /// <param name="config">消费者配置</param>
        /// <param name="callBack">消费者回调</param>
        public void Subscribe(KafkaConsumerMod config, Action<string> callBack)
        {
            _Consumers.TryGetValue(config, out var consumer);
            if (consumer == null)
            {
                _Consumers.TryAdd(config, new KafkaConsumer(config));
                _Consumers.TryGetValue(config, out consumer);
                consumer.Subscribe(callBack);
            }
        }

        /// <summary>
        /// 生产者发布
        /// </summary>
        /// <param name="config">生产者配置</param>
        /// <param name="data">生产的数据</param>
        public void Publich(KafkaProducerMod config, string data)
        {
            _Producers.TryGetValue(config, out var producer);
            if (producer == null)
            {
                _Producers.TryAdd(config, new KafkaProducer(config));
                _Producers.TryGetValue(config, out producer);
                producer.Publich(data);
            }
        }
    }
}
