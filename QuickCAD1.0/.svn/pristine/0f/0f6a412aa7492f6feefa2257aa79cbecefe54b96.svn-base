<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>任务配置</title>
    <link rel="stylesheet" href="../comm/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../comm/css/layui.css" />
    <link rel="stylesheet" href="../comm/css/globle.css" />

    <style>
        .editrwpz {
            width: 360px;
            height: 420px;
        }
        
        .selectdbs {
            width: 360px;
            height: 240px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="handle">
            <img id="add" src="../comm/img/add.png" alt="" />
            <img id="delete" src="../comm/img/delete.png" alt="" />
            <img id="update" src="../comm/img/alert.png" alt="" />
            <input type="text" class="select-input" name="condition" placeholder="请输入命令码">
            <img id="select" src="../comm/img/select.png" alt="" />
        </div>
        <!--以下为两个必须div元素-->
        <div id="table" class="table-div"></div>
        <div id="pageBar" class="txtRight"></div>
    </div>

    <!-- 配置任务命令码 -->
    <div class="peizhi pz_dbcmd">
        <div class="pz-header">
            <span class="pz-title">任务命令码配置</span>
            <button type="button" class="close" id="pz_dbcmd_close"><span style="color: #0C4EF7;">&times;</span></button>
        </div>
        <div class="pz-content">
            <div class="flexDiv"><span>命令码：</span><input type="text" id="cmd" autocomplete="off"></div>
            <div class="flexDiv"><span>表名：</span><input type="text" id="tname"></div>
            <div class="flexDiv"><span>主键：</span><input type="text" id="keys"></div>
            <div class="flexDiv"><span>数据库：</span><input type="text" id="dbs" readonly="true"></div>
            <div class="flexDiv"><span>备注：</span><input type="text" id="des"></div>
        </div>
        <div class="pz-footer">
            <button type="button" class="btn btn-primary" id="pz_dbcmd_confirm">确认</button>
            <button type="button" class="btn btn-default btn-danger" id="pz_dbcmd_cancel">取消</button>
        </div>
    </div>

    <!-- 选择数据库 -->
    <div class="peizhi pz_dbs">
        <div class="pz-header">
            <span class="pz-title">GA数据库选择</span>
            <button type="button" class="close" id="pz_dbs_close"><span style="color:#0C4EF7;">&times;</span></button>
        </div>
        <div class="pz-content">
            <div class="flexDiv">
                <span>选择数据库：</span>
                <select class="pz-select" id="dbsselect" multiple="multiple"></select>
            </div>
        </div>
        <div class="pz-footer">
            <button type="button" class="btn btn-primary" id="pz_dbs_confirm">确认</button>
            <button type="button" class="btn btn-default btn-danger" id="pz_dbs_cancel">取消</button>
        </div>
    </div>

    <script type="text/javascript" src="../comm/js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="../comm/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../comm/js/template-native.js"></script>
    <script type="text/javascript" src="../comm/js/layui.js"></script>
    <script type="text/javascript" src="../comm/js/mygloble.js"></script>
    <script type="text/javascript" src="../comm/js/myutil.js"></script>
    <script type="text/javascript" src="../comm/js/mypage.js"></script>
    <script>
        var json = []; //标准json格式 目前只支持[{a:b,c:d},{a:b,c:d}]此种格式 
        //nameList与widthList的数组长度要一致
        var nameList = ['', '命令码', '表名', '主键', '数据库', '备注'] //table的列名
        var widthList = [5, 20, 100, 100, 100, 120] //table每列的宽度

        $(function() {
            UpdataPage(); // 加载页面时初始化表格
            DbCmdQuery(); //初始化表格数据
            LoadGaDb(); //加载数据库

            // 点击查询按钮
            $("#select").on("click", function() {
                DbCmdQuery();
            });

            // 点击删除按钮
            $("#delete").on("click", function() {
                if ($("input[name='checktr']:checked").length <= 0) {
                    alert("请至少选择其中一项数据进行删除！")
                    return false;
                }
                var msg = "确定要删除吗？\n\n请确认！";
                if (confirm(msg) == false) {
                    return false;
                } else {
                    var idArr = [];
                    // 删除选择的列表项
                    $(".trcheck").each(function(i, item) {
                        if ($(this).prop("checked")) {
                            var id = $(this).parents("tr").find("td").eq(1).text();
                            idArr.push(id);
                        }
                    });
                    $.ajax({
                        url: "http://" + params + "/app/res_dbcmd/delete",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            ids: idArr
                        },
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                DbCmdQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                }
            });

            // 点击添加按钮
            $("#add").on("click", function() {
                $("#cmd").removeAttr("disabled");
                $("#pz_dbcmd_confirm").attr("czlx", "0");
                $(".pz_dbcmd").css("display", "block");
            });

            // 点击修改按钮
            $("#update").on("click", function() {
                if ($("input[name='checktr']:checked").length != 1) {
                    alert("请选择其中一项数据进行修改！")
                    return false;
                }
                $(".trcheck").each(function(i, item) {
                    if ($(this).prop('checked')) {
                        $("#cmd").attr({
                            "disabled": "disabled"
                        });
                        var id = $(this).parents("tr").find("td").eq(1).text();
                        var data = json.filter(p => p.cmd == id)[0];
                        $("input[id='cmd']").val(data.cmd);
                        $("input[id='tname']").val(data.tname);
                        $("input[id='keys']").val(data.keys);
                        $("input[id='dbs']").val(data.dbId);
                        $("input[id='des']").val(data.bz);
                    }
                });
                $("#pz_dbcmd_confirm").attr("czlx", "1");
                $(".pz_dbcmd").css("display", "block");
            });

            // 【任务配置框】关闭按钮
            $("#pz_dbcmd_close").on("click", function() {
                $(".pz_dbcmd").css("display", "none");
            });

            // 【任务配置框】确定按钮
            $("#pz_dbcmd_confirm").on("click", function() {
                var cmd = $("input[id='cmd']").val();
                var tname = $("input[id='tname']").val();
                var keys = $("input[id='keys']").val();
                var dbs = $("input[id='dbs']").val();
                var des = $("input[id='des']").val();
                if ($(this).attr("czlx") == "0") {
                    //添加操作
                    $.ajax({
                        url: "http://" + params + "/app/res_dbcmd/add",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            cmd: cmd,
                            tname: tname,
                            keys: keys,
                            dbs: dbs,
                            des: des
                        },
                        async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                DbCmdQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                } else {
                    //修改操作
                    $.ajax({
                        url: "http://" + params + "/app/res_dbcmd/alert",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            cmd: cmd,
                            tname: tname,
                            keys: keys,
                            dbs: dbs,
                            des: des
                        },
                        async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                DbCmdQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                }
                $(".pz_dbcmd").css("display", "none");
            });

            // 【任务配置框】取消按钮
            $("#pz_dbcmd_cancel").on("click", function() {
                $(".pz_dbcmd").css("display", "none");
            });

            // 点击选择数据库
            $("#dbs").on("click", function() {
                var gadbs = $("input[id='dbs']").val();
                if (gadbs) {
                    var dbarray = gadbs.split(',');
                    $("#dbsselect option").each(function(i, v) {
                        var tfalg = dbarray.includes($(v).val()) ? true : false;
                        $(this).prop("selected", tfalg);
                    });
                }
                $(".pz_dbs").css("display", "block");
            });

            // 【数据库选择框】关闭按钮
            $("#pz_dbs_close").on("click", function() {
                $(".pz_dbs").css("display", "none");
            });

            // 【数据库选择框】确定按钮
            $("#pz_dbs_confirm").on("click", function() {
                var select = document.getElementById("dbsselect");
                var dbsstr = ""; //字符串，用逗号隔开
                for (i = 0; i < select.length; i++) {
                    if (select.options[i].selected) {
                        dbsstr += select[i].value + ",";
                    }
                }
                var reg = /,$/gi;
                dbs = dbsstr.replace(reg, ""); //去除最后一个逗号
                $("input[id='dbs']").val(dbs);
                $(".pz_dbs").css("display", "none");
            });

            // 【数据库选择框】取消按钮
            $("#pz_dbs_cancel").on("click", function() {
                $(".pz_dbs").css("display", "none");
            });
        });


        /**任务命令码查询 */
        function DbCmdQuery() {
            var condition = $("input[name='condition']").val();
            $.ajax({
                url: "http://" + params + "/app/res_dbcmd/query",
                headers: {
                    "Authorization": localStorage.getItem("mytoken")
                }, //本地token
                type: "get",
                data: {
                    condition: condition
                },
                success: function(res) {
                    json = (res == null) ? [] : res;
                    reloadpage();
                }
            })
        }

        /**加载Ga数据库 */
        function LoadGaDb() {
            $.ajax({
                url: "http://" + params + "/app/res_gasjk/query",
                headers: {
                    "Authorization": localStorage.getItem("mytoken")
                }, //本地token
                type: "get",
                data: {
                    condition: null
                },
                success: function(res) { //如果请求返回数据正常,动态加载界面
                    if (res) {
                        var html = "";
                        for (var i = 0; i < res.length; i++) {
                            html += "<option value='" + res[i].id + "' selected='true'>" + res[i].describe + "</option>";
                        }
                        $("#dbsselect").html(html);
                    }
                }
            });
        }
    </script>
</body>

</html>