var json = []; //列表数据
//nameList与widthList的数组长度要一致
var nameList = ["", "编号", "时间", "级别", "内容", "方法", "数量", "堆栈"]; //table的列名
var widthList = [5, 10, 30, 20, 200, 30, 10, 200]; //table每列的宽度

//Main
$(function() {
    $(".datetimepicker").datetimepicker({
        format: "yyyy-mm-dd hh:ii:ss",
        autoclose: true,
        minView: 0,
        minuteStep: 1,
        language: "zh-CN",
        initialDate: new Date(), //初始化当前日期s
        // startDate:new Date(),
        todayBtn: true
    });
    $("#start_time_picker").datetimepicker("setDate", new Date(fun_date(-7)));
    $("#end_time_picker").datetimepicker("setDate", new Date());

    UpdataPage(); //表格初始化
    XtrzQuery(); //初始化常规日志数据

    // 点击查询按钮
    $("#select").on("click", function() {
        XtrzQuery(); //查询常规日志数据
    });

    // 点击删除按钮
    $("#delete").on("click", function() {
        if ($("input[name='checktr']:checked").length <= 0) {
            alert("请至少选择其中一项数据进行删除！")
            return false;
        }
        var delArr = [];
        // 删除选择的列表项
        $(".trcheck").each(function(i, item) {
            if ($(this).prop("checked")) {
                var a = $(this).parents("tr").find("td").eq(1).text();
                delArr.push(a);
            }
        });

        $.ajax({
            url: "http://" + params + "/app/log_xtrz/delete",
            headers: { "Authorization": localStorage.getItem("mytoken") }, //本地token
            type: "post",
            data: {
                ids: delArr
            },
            async: false,
            error: function() {
                console.log("错误");
            },
            success: function(res) {
                if (res) {
                    XtrzQuery(); //刷新界面
                }
            }
        });

    });

    // 点击清除按钮
    $("#clear").on("click", function() {
        $.ajax({
            url: "http://" + params + "/app/log_xtrz/clear",
            headers: { "Authorization": localStorage.getItem("mytoken") }, //本地token
            type: "post",
            async: false,
            error: function() {
                console.log("错误");
            },
            success: function(res) {
                if (res) {
                    XtrzQuery(); //刷新界面
                }
            }
        });
    });

    // 导出数据
    $("#export").on("click", function() {
        var slevel = $("#levelSelect option:selected").text();
        var start_time = $("input[name='start_time']").val();
        var end_time = $("input[name='end_time']").val();
        if (!start_time || !end_time) {
            alert("请输入完整时间段!");
        } else {
            var startTime = palindrome(start_time);
            var endTime = palindrome(end_time);
            $.ajax({
                url: "http://" + params + "/app/log_xtrz/query",
                headers: { "Authorization": localStorage.getItem("mytoken") }, //本地token
                type: "get",
                data: {
                    time1: stime,
                    time2: etime,
                    condition: slevel
                },
                error: function() {
                    alert("导出系统日志失败！");
                },
                success: function(res) {
                    console.log(res);
                    alert("导出系统日志成功！");
                }
            });
        }
    });
});

/**系统日志查询 */
function XtrzQuery() {
    var slevel = $("#levelSelect option:selected").val();
    var start_time = $("input[name='start_time']").val();
    var end_time = $("input[name='end_time']").val();
    if (!start_time || !end_time) {
        alert("请输入完整时间段!");
    } else {
        var startTime = palindrome(start_time);
        var endTime = palindrome(end_time);
        $.ajax({
            url: "http://" + params + "/app/log_xtrz/query",
            headers: { "Authorization": localStorage.getItem("mytoken") }, //本地token
            type: "get",
            data: {
                time1: startTime,
                time2: endTime,
                condition: slevel
            },
            async: false,
            error: function() {
                console.log("错误");
            },
            success: function(res) {
                // console.log(res);
                json = (res == null) ? [] : res;
                reloadpage();
            }
        });
    }
}

//时间转字符串
function palindrome(str) {
    // 先后去除空格和非数字字母的字符
    var newStr = str
        .replace(/\s/g, "")
        .replace(/[^a-zA-Z0-9]/g, "")
        .toLowerCase();
    return newStr;
}

function fun_date(num) {
    var date1 = new Date();
    //今天时间
    var time1 = date1.getFullYear() + "-" + (date1.getMonth() + 1) + "-" + date1.getDate()
    var date2 = new Date(date1);
    date2.setDate(date1.getDate() + num);
    //num是正数表示之后的时间，num负数表示之前的时间，0表示今天
    var time2 = date2.getFullYear() + "-" + (date2.getMonth() + 1) + "-" + date2.getDate() + " " + date2.getHours() + ":" + date2.getMinutes() + ":" + date2.getSeconds();
    return time2;
}