<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>任务配置</title>
    <link rel="stylesheet" href="../comm/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../comm/css/layui.css" />
    <link rel="stylesheet" href="../comm/css/globle.css" />

    <style>
        .editrwpz {
            width: 360px;
            height: 420px;
        }
        
        .selectdbs {
            width: 360px;
            height: 240px;
        }
        
        .selectbds {
            width: 860px;
            height: 540px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="handle">
            <img id="add" src="../comm/img/add.png" alt="" />
            <img id="delete" src="../comm/img/delete.png" alt="" />
            <img id="update" src="../comm/img/alert.png" alt="" />
            <input type="text" class="select-input" name="condition" placeholder="请输入任务名">
            <img id="select" src="../comm/img/select.png" alt="" />
            <span id="qy">启用</span>
            <span id="ty">停用</span>
        </div>
        <!--以下为两个必须div元素-->
        <div id="table" class="table-div"></div>
        <div id="pageBar" class="txtRight"></div>
    </div>

    <!-- 配置任务调度 -->
    <div class="peizhi editrwpz">
        <div class="pz-header">
            <span class="pz-title">调度器编辑</span>
            <button type="button" class="close" id="editrwpz_close"><span style="color:#0C4EF7;">&times;</span></button>
        </div>
        <div class="pz-content">
            <div class="flexDiv">
                <span>任务名称：</span>
                <select class="pz-select" id="jobSelect"></select>
            </div>
            <div class="flexDiv">
                <span>是否启用：</span>
                <input type="radio" name="canuse" value="true">是&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <input type="radio" name="canuse" value="false" checked="true">否&nbsp;&nbsp;
            </div>
            <div class="flexDiv"><span>表达式：</span><input id="cron" type="text"></div>
            <div class="flexDiv">
                <span>表达式描述：</span>
                <textarea class="pz-textarea" id="ms" cols="30" rows="5"></textarea>
            </div>
        </div>
        <div class="pz-footer">
            <button type="button" class="btn btn-primary" id="editrwpz_confirm">确认</button>
            <button type="button" class="btn btn-default btn-danger" id="editrwpz_cancel">取消</button>
        </div>
    </div>

    <script type="text/javascript" src="../comm/js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="../comm/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../comm/js/template-native.js"></script>
    <script type="text/javascript" src="../comm/js/layui.js"></script>
    <script type="text/javascript" src="../comm/js/mygloble.js"></script>
    <script type="text/javascript" src="../comm/js/myutil.js"></script>
    <script type="text/javascript" src="../comm/js/mypage.js"></script>
    <script>
        var json = []; //标准json格式 目前只支持[{a:b,c:d},{a:b,c:d}]此种格式 
        //nameList与widthList的数组长度要一致
        var nameList = ['', 'JOB名称', 'JOB类型', 'JOB描述', '是否启用',  '表达式', '表达式描述'] //table的列名
        var widthList = [5, 20, 100, 100, 100, 100, 100] //table每列的宽度

        $(function() {
            UpdataPage(); // 加载页面时初始化表格
            RwpzQuery(); //初始化表格数据
            LoadJobs(); //加载调度器列表

            // 点击查询按钮
            $("#select").on("click", function() {
                RwpzQuery();
            });

            // 点击删除按钮
            $("#delete").on("click", function() {
                if ($("input[name='checktr']:checked").length <= 0) {
                    alert("请至少选择其中一项数据进行删除！")
                    return false;
                }
                var msg = "确定要删除吗？\n\n请确认！";
                if (confirm(msg) == false) {
                    return false;
                } else {
                    var idArr = [];
                    // 删除选择的列表项
                    $(".trcheck").each(function(i, item) {
                        if ($(this).prop("checked")) {
                            var id = $(this).parents("tr").find("td").eq(1).text();
                            idArr.push(id);
                        }
                    });
                    $.ajax({
                        url: "http://" + params + "/app/res_rwpz/delete",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            ids: idArr
                        },
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                RwpzQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                }
            });

            // 点击添加按钮
            $("#add").on("click", function() {
                $("#jobSelect").removeAttr("disabled");
                $("#editrwpz_confirm").attr("czlx", "0");
                $(".editrwpz").css("display", "block");
            });

            // 点击修改按钮
            $("#update").on("click", function() {
                if ($("input[name='checktr']:checked").length != 1) {
                    alert("请选择其中一项数据进行修改！")
                    return false;
                }
                $(".trcheck").each(function(i, item) {
                    if ($(this).prop('checked')) {
                        $("#jobSelect").attr({
                            "disabled": "disabled"
                        });
                        var id = $(this).parents("tr").find("td").eq(1).text();
                        var data = json.filter(p => p.jobName == id)[0];
                        $("#jobSelect").val(data.jobName);
                        $("input[name='canuse'][value='" + data.state + "']").click(); //是否可用
                        $("input[id='cron']").val(data.cronExpression);
                        $("textarea[id='ms']").val(data.description);
                    }
                });
                $("#editrwpz_confirm").attr("czlx", "1");
                $(".editrwpz").css("display", "block");
            });

            // 启用
            $("#qy").on("click", function() {
                if ($("input[name='checktr']:checked").length == 0) {
                    alert("请选择启用项!");
                    return false;
                }
                var idArr = [];
                $(".trcheck").each(function(i, item) {
                    if ($(this).prop('checked')) {
                        var id = $(this).parents("tr").find("td").eq(1).text();
                        idArr.push(id);
                    }
                });
                $.ajax({
                    url: "http://" + params + "/app/res_rwpz/start",
                    headers: {
                        "Authorization": localStorage.getItem("mytoken")
                    }, //本地token
                    type: "post",
                    data: {
                        ids: idArr
                    },
                    // async: false,
                    error: function() {
                        console.log("错误");
                    },
                    success: function(res) {
                        // 如果请求成功，将返回的json数组赋给数组json
                        if (res == true) {
                            RwpzQuery();
                        } else {
                            alert(res)
                        }
                    }
                });
            });

            // 停用
            $("#ty").on("click", function() {
                if ($("input[name='checktr']:checked").length == 0) {
                    alert("请选择停用项!");
                    return false;
                }
                var idArr = [];
                $(".trcheck").each(function(i, item) {
                    if ($(this).prop('checked')) {
                        var id = $(this).parents("tr").find("td").eq(1).text();
                        idArr.push(id);
                    }
                });
                $.ajax({
                    url: "http://" + params + "/app/res_rwpz/stop",
                    headers: {
                        "Authorization": localStorage.getItem("mytoken")
                    }, //本地token
                    type: "post",
                    data: {
                        ids: idArr
                    },
                    // async: false,
                    error: function() {
                        console.log("错误");
                    },
                    success: function(res) {
                        // 如果请求成功，将返回的json数组赋给数组json
                        if (res == true) {
                            RwpzQuery();
                        } else {
                            alert(res)
                        }
                    }
                });
            });

            // 【任务配置框】关闭按钮
            $("#editrwpz_close").on("click", function() {
                $(".editrwpz").css("display", "none");
            });

            // 【任务配置框】取消按钮
            $("#editrwpz_cancel").on("click", function() {
                $(".editrwpz").css("display", "none");
            });

            // 【任务配置框】确定按钮
            $("#editrwpz_confirm").on("click", function() {
                var sdata = JSON.parse($("#jobSelect").find("option:selected").attr("data"));
                _sname = sdata.jobName;
                _jobtype = sdata.jobType;
                _classnote = sdata.jobDesc;
                var _sta = $('input[name="canuse"]:checked').val();
                var _cron = $("input[id='cron']").val();
                var _desc = $("textarea[id='ms']").val();
                if ($(this).attr("czlx") == "0") {
                    //添加操作
                    $.ajax({
                        url: "http://" + params + "/app/res_rwpz/add",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            sname: _sname,
                            jobtype: _jobtype,
                            classnote: _classnote,
                            state: _sta,
                            cron: _cron,
                            desc: _desc
                        },
                        // async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                RwpzQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                } else {
                    //修改操作
                    $.ajax({
                        url: "http://" + params + "/app/res_rwpz/alert",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            sname: _sname,
                            jobtype: _jobtype,
                            classnote: _classnote,
                            state: _sta,
                            cron: _cron,
                            desc: _desc
                        },
                        // async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            // 如果请求成功，将返回的json数组赋给数组json
                            if (res == true) {
                                RwpzQuery();
                            } else {
                                alert(res)
                            }
                        }
                    });
                }
                $(".editrwpz").css("display", "none");
            });
        });

        /**任务配置查询 */
        function RwpzQuery() {
            var condition = $("input[name='condition']").val();
            $.ajax({
                url: "http://" + params + "/app/res_rwpz/query",
                headers: {
                    "Authorization": localStorage.getItem("mytoken")
                }, //本地token
                type: "get",
                data: {
                    condition: condition
                },
                success: function(res) {
                    json = (res == null) ? [] : res;
                    reloadpage();
                }
            })
        }

        /**加载调度器列表 */
        function LoadJobs() {
            $.ajax({
                url: "http://" + params + "/app/res_rwpz/loadjobs",
                headers: {
                    "Authorization": localStorage.getItem("mytoken")
                }, //本地token
                type: "get",
                data: {},
                success: function(res) { //如果请求返回数据正常,动态加载界面
                    if (res) {
                        var html = "";
                        for (var i = 0; i < res.length; i++) {
                            html += "<option value='" + res[i].jobName + "' " + "data='" + JSON.stringify(res[i]) + "'>" + res[i].jobDesc + "</option>";
                        }
                        $("#jobSelect").html(html);
                    }
                }
            });
        }
    </script>
</body>

</html>