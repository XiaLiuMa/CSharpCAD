<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>系统日志</title>
    <link rel="stylesheet" href="../comm/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../comm/css/bootstrap-datetimepicker.min.css" />
    <link rel="stylesheet" href="../comm/css/layui.css">
    <link rel="stylesheet" href="../comm/css/globle.css" />
</head>

<body>
    <div class="container-fluid">
        <div class="handle">
            <div class="timebox flexbox m-r-20">
                <span>选择时间段：</span>
                <input type="datetime" value="" readonly=true name="start_time" id="start_time_picker" class="datetimepicker" />
                <span>至</span>
                <input type="datetime" value="" readonly=true name="end_time" id="end_time_picker" class="datetimepicker" />
                <input type="text" class="select-input" name="condition" placeholder="请输入日志级别">
                <img id="select" src="../comm/img/select.png" alt="" />
                <img id="delete" src="../comm/img/delete.png" alt="" />
                <img id="clear" src="../comm/img/clear.png" alt="" />
                <img id="export" src="../comm/img/exportpage.png" alt="" />
            </div>
        </div>
        <!--以下为两个必须div元素-->
        <div id="table" class="table-div"></div>
        <div id="pageBar" class="txtRight"></div>
    </div>

    <script src="../comm/js/jquery-2.0.3.min.js"></script>
    <script src="../comm/js/bootstrap.min.js"></script>
    <script src="../comm/js/layui.js"></script>
    <script src="../comm/js/mypage.js"></script>
    <script type="text/javascript" src="../comm/js/mygloble.js"></script>
    <script type="text/javascript" src="../comm/js/myutil.js"></script>
    <script src="../comm/js/bootstrap-datepicker.js"></script>
    <script src="../comm/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../comm/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    <script>
        var json = []; //列表数据
        //nameList与widthList的数组长度要一致
        var nameList = ["", "编号", "时间", "级别", "内容", "方法", "数量", "堆栈"]; //table的列名
        var widthList = [5, 10, 30, 20, 200, 30, 10, 200]; //table每列的宽度

        //Main
        $(function() {
            $(".datetimepicker").datetimepicker({
                format: "yyyy-mm-dd hh:ii:ss",
                autoclose: true,
                minView: 0,
                minuteStep: 1,
                language: "zh-CN",
                initialDate: new Date(), //初始化当前日期s
                todayBtn: true
            });
            $("#start_time_picker").datetimepicker("setDate", new Date(fun_date(-7)));
            $("#end_time_picker").datetimepicker("setDate", new Date());

            UpdataPage(); //表格初始化
            XtrzQuery(); //初始化常规日志数据

            // 点击查询按钮
            $("#select").on("click", function() {
                XtrzQuery(); //查询常规日志数据
            });

            // 点击删除按钮
            $("#delete").on("click", function() {
                if ($("input[name='checktr']:checked").length <= 0) {
                    alert("请至少选择其中一项数据进行删除！")
                    return false;
                }
                var msg = "确定要删除吗？\n\n请确认！";
                if (confirm(msg) == false) {
                    return false;
                } else {
                    var idArr = [];
                    // 删除选择的列表项
                    $(".trcheck").each(function(i, item) {
                        if ($(this).prop("checked")) {
                            var a = $(this).parents("tr").find("td").eq(1).text();
                            idArr.push(a);
                        }
                    });

                    $.ajax({
                        url: "http://" + params + "/app/log_xtrz/delete",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        data: {
                            ids: idArr
                        },
                        async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            if (res) {
                                XtrzQuery(); //刷新界面
                            }
                        }
                    });
                }
            });

            // 点击清除按钮
            $("#clear").on("click", function() {
                var msg = "确定要清空吗？\n\n请确认！";
                if (confirm(msg) == false) {
                    return false;
                } else {
                    $.ajax({
                        url: "http://" + params + "/app/log_xtrz/clear",
                        headers: {
                            "Authorization": localStorage.getItem("mytoken")
                        }, //本地token
                        type: "post",
                        async: false,
                        error: function() {
                            console.log("错误");
                        },
                        success: function(res) {
                            if (res) {
                                XtrzQuery(); //刷新界面
                            }
                        }
                    });
                }
            });

            // 导出数据
            $("#export").on("click", function() {
                alert("暂不支持导出！");
                // var slevel = $("#levelSelect option:selected").text();
                // var start_time = $("input[name='start_time']").val();
                // var end_time = $("input[name='end_time']").val();
                // if (!start_time || !end_time) {
                //     alert("请输入完整时间段!");
                // } else {
                //     var startTime = palindrome(start_time);
                //     var endTime = palindrome(end_time);
                //     $.ajax({
                //         url: "http://" + params + "/app/log_xtrz/query",
                //         headers: {
                //             "Authorization": localStorage.getItem("mytoken")
                //         }, //本地token
                //         type: "get",
                //         data: {
                //             time1: stime,
                //             time2: etime,
                //             condition: slevel
                //         },
                //         error: function() {
                //             alert("导出系统日志失败！");
                //         },
                //         success: function(res) {
                //             console.log(res);
                //             alert("导出系统日志成功！");
                //         }
                //     });
                // }
            });
        });

        /**系统日志查询 */
        function XtrzQuery() {
            var condition = $("input[name='condition']").val();
            var start_time = $("input[name='start_time']").val();
            var end_time = $("input[name='end_time']").val();
            if (!start_time || !end_time) {
                alert("请输入完整时间段!");
            } else {
                var startTime = palindrome(start_time);
                var endTime = palindrome(end_time);
                $.ajax({
                    url: "http://" + params + "/app/log_xtrz/query",
                    headers: {
                        "Authorization": localStorage.getItem("mytoken")
                    }, //本地token
                    type: "get",
                    data: {
                        time1: startTime,
                        time2: endTime,
                        condition: condition
                    },
                    async: false,
                    error: function() {
                        console.log("错误");
                    },
                    success: function(res) {
                        json = (res == null) ? [] : res;
                        reloadpage();
                    }
                });
            }
        }

        //时间转字符串
        function palindrome(str) {
            // 先后去除空格和非数字字母的字符
            var newStr = str
                .replace(/\s/g, "")
                .replace(/[^a-zA-Z0-9]/g, "")
                .toLowerCase();
            return newStr;
        }

        function fun_date(num) {
            var date1 = new Date();
            //今天时间
            var time1 = date1.getFullYear() + "-" + (date1.getMonth() + 1) + "-" + date1.getDate()
            var date2 = new Date(date1);
            date2.setDate(date1.getDate() + num);
            //num是正数表示之后的时间，num负数表示之前的时间，0表示今天
            var time2 = date2.getFullYear() + "-" + (date2.getMonth() + 1) + "-" + date2.getDate() + " " + date2.getHours() + ":" + date2.getMinutes() + ":" + date2.getSeconds();
            return time2;
        }
    </script>
</body>

</html>